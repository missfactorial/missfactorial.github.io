<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog System Test</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Blog Pagination CSS -->
  <link href="assets/css/blog-pagination.css" rel="stylesheet">
  
  <style>
    body {
      padding: 20px;
    }
    .header {
      margin-bottom: 30px;
    }
    .test-controls {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Blog System Test</h1>
      <p>This page tests the blog system with a simplified CSV file.</p>
    </div>
    
    <div class="test-controls">
      <h3>Test Controls</h3>
      <button id="loadTest" class="btn btn-primary">Load Test CSV</button>
      <button id="loadReal" class="btn btn-secondary">Load Real CSV</button>
      <div id="testStatus" class="mt-3"></div>
    </div>
    
    <div class="row">
      <div class="col-12">
        <!-- Blog Container - Will be populated by JavaScript -->
        <div id="blog-container"></div>
        
        <!-- Pagination -->
        <div id="pagination" class="pagination"></div>
      </div>
    </div>
  </div>
  
  <!-- Vendor JS Files -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Blog display configuration
    const POSTS_PER_PAGE = 10;
    let currentPage = 1;
    let totalPosts = 0;
    let blogData = [];
    let currentCSV = 'news.csv';
    
    // Function to parse CSV data
    function parseCSV(text) {
      try {
        console.log('Starting CSV parsing...');
        
        // Split the text into lines
        const lines = text.split('\n').filter(line => line.trim() !== '');
        console.log(`Found ${lines.length} non-empty lines in CSV`);
        
        if (lines.length === 0) {
          throw new Error('CSV file has no content');
        }
        
        // Extract headers from the first line
        const headers = lines[0].split(',').map(header => header.trim());
        console.log('CSV Headers:', headers);
        
        // Check for required headers
        const requiredHeaders = ['Title', 'Description'];
        const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
        
        if (missingHeaders.length > 0) {
          throw new Error(`Missing required headers in CSV: ${missingHeaders.join(', ')}`);
        }
        
        // Process each line (skip the header line)
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          // Handle commas within quoted fields
          const values = [];
          let currentValue = '';
          let insideQuotes = false;
          
          for (let j = 0; j < lines[i].length; j++) {
            const char = lines[i][j];
            
            if (char === '"') {
              insideQuotes = !insideQuotes;
            } else if (char === ',' && !insideQuotes) {
              values.push(currentValue.trim());
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          
          // Add the last value
          values.push(currentValue.trim());
          
          // Create an object with the headers as keys
          const entry = {};
          headers.forEach((header, index) => {
            if (header) { // Only process non-empty headers
              entry[header] = values[index] || '';
            }
          });
          
          // Only add entries with a title or description
          if (entry['Title'] || entry['Description']) {
            data.push(entry);
          } else {
            console.log(`Skipping row ${i+1} due to missing Title and Description`);
          }
        }
        
        console.log(`Successfully parsed ${data.length} blog entries from CSV`);
        return data;
      } catch (error) {
        console.error('Error parsing CSV:', error);
        throw new Error('Failed to parse CSV data: ' + error.message);
      }
    }
    
    // Function to fetch blog data from CSV file
    async function fetchBlogData(csvFile) {
      const blogContainer = document.getElementById('blog-container');
      const testStatus = document.getElementById('testStatus');
      
      testStatus.innerHTML = `<div class="alert alert-info">Loading ${csvFile}...</div>`;
      
      try {
        const response = await fetch(csvFile);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch CSV data: ${response.status} ${response.statusText}`);
        }
        
        const csvText = await response.text();
        
        if (!csvText || csvText.trim() === '') {
          throw new Error('CSV file is empty');
        }
        
        console.log('CSV data loaded successfully');
        // Debug: Show first few lines of CSV
        debugCSV(csvText);
        
        blogData = parseCSV(csvText);
        
        if (blogData.length === 0) {
          throw new Error('No valid blog posts found in CSV');
        }
        
        console.log(`Parsed ${blogData.length} blog posts from CSV`);
        
        // Map CSV columns to our expected format
        blogData = blogData.map(post => {
          return {
            title: post['Title'] || 'Untitled Post',
            date: post['Date'] || '',
            location: post['Location'] || (post['City'] ? post['City'] : ''),
            content: post['Description'] || '',
            type: post['Type'] || '',
            organization: post['Organization/Event'] || '',
            // We'll handle images separately if they exist in the CSV
            images: post['Images'] || ''
          };
        });
        
        // Sort by date (newest first)
        blogData.sort((a, b) => {
          const dateA = new Date(a.date || '');
          const dateB = new Date(b.date || '');
          return dateB - dateA;
        });
        
        totalPosts = blogData.length;
        
        // Display the first page of posts
        displayBlogPosts();
        setupPagination();
        
        testStatus.innerHTML = `<div class="alert alert-success">Successfully loaded ${blogData.length} posts from ${csvFile}</div>`;
        
      } catch (error) {
        console.error('Error fetching blog data:', error);
        blogContainer.innerHTML = `
          <div class="alert alert-danger">
            Failed to load blog posts. Please try again later.<br>
            <small>Error details: ${error.message}</small>
          </div>
        `;
        testStatus.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      }
    }
    
    // Debug function to display CSV content
    function debugCSV(csvText) {
      const lines = csvText.split('\n').slice(0, 5); // Get first 5 lines
      console.log('CSV Preview (first 5 lines):');
      lines.forEach((line, index) => {
        console.log(`Line ${index + 1}: ${line}`);
      });
    }
    
    // Function to display blog posts for the current page
    function displayBlogPosts() {
      const blogContainer = document.getElementById('blog-container');
      blogContainer.innerHTML = '';
      
      const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
      const endIndex = Math.min(startIndex + POSTS_PER_PAGE, totalPosts);
      
      if (totalPosts === 0) {
        blogContainer.innerHTML = '<div class="alert alert-info">No blog posts found.</div>';
        return;
      }
      
      for (let i = startIndex; i < endIndex; i++) {
        const post = blogData[i];
        
        // Create blog post HTML
        const postElement = document.createElement('section');
        postElement.id = `post-${i + 1}`;
        postElement.className = 'portfolio-details';
        
        // Add section-bg class for odd-indexed posts (for alternating background)
        if (i % 2 !== 0) {
          postElement.classList.add('section-bg');
        }
        
        // Create content HTML
        postElement.innerHTML = `
          <div class="container" data-aos="fade-up">
            <div class="row gy-4">
              <div class="col-12">
                <div class="portfolio-info" style="background-color: white">
                  <h3>${post.title || 'Untitled Post'}</h3>
                  <ul>
                    ${post.type ? `<li><strong>Type</strong>: ${post.type}</li>` : ''}
                    ${post.date ? `<li><strong>Date</strong>: ${post.date}</li>` : ''}
                    ${post.location ? `<li><strong>Location</strong>: ${post.location}</li>` : ''}
                    ${post.organization ? `<li><strong>Organization</strong>: ${post.organization}</li>` : ''}
                    <br>
                    ${post.content ? post.content.replace(/\n/g, '<br><br>') : 'No content available.'}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
        
        blogContainer.appendChild(postElement);
      }
    }
    
    // Function to set up pagination
    function setupPagination() {
      const paginationElement = document.getElementById('pagination');
      const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
      
      if (totalPages <= 1) {
        paginationElement.style.display = 'none';
        return;
      }
      
      paginationElement.style.display = 'flex';
      paginationElement.innerHTML = '';
      
      // Previous button
      const prevButton = document.createElement('a');
      prevButton.href = '#';
      prevButton.innerHTML = '&laquo;';
      prevButton.className = currentPage === 1 ? 'disabled' : '';
      prevButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          displayBlogPosts();
          setupPagination();
          window.scrollTo(0, 0);
        }
      });
      paginationElement.appendChild(prevButton);
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLink = document.createElement('a');
        pageLink.href = '#';
        pageLink.textContent = i;
        pageLink.className = i === currentPage ? 'active' : '';
        pageLink.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          displayBlogPosts();
          setupPagination();
          window.scrollTo(0, 0);
        });
        paginationElement.appendChild(pageLink);
      }
      
      // Next button
      const nextButton = document.createElement('a');
      nextButton.href = '#';
      nextButton.innerHTML = '&raquo;';
      nextButton.className = currentPage === totalPages ? 'disabled' : '';
      nextButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          displayBlogPosts();
          setupPagination();
          window.scrollTo(0, 0);
        }
      });
      paginationElement.appendChild(nextButton);
    }
    
    // Set up event listeners for test controls
    document.getElementById('loadTest').addEventListener('click', () => {
      currentCSV = 'test-news.csv';
      currentPage = 1;
      fetchBlogData(currentCSV);
    });
    
    document.getElementById('loadReal').addEventListener('click', () => {
      currentCSV = 'news.csv';
      currentPage = 1;
      fetchBlogData(currentCSV);
    });
    
    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', function() {
      fetchBlogData(currentCSV);
    });
  </script>
</body>
</html> 